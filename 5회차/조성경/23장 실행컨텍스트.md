

## 23.1 소스코드의 타입

#### 전역 코드
- 전역 변수를 관리하기 위한 최상위 스코프인 `전역 스코프`를 생성
- `var` 키워드로 선언된 전역 변수, 함수 선언문으로 정의된 전역 함수를 전역 객체의 프로퍼티와 메서드로 바인딩
  
> **Javascript에서의 바인딩 예시**
> JavaScript에서 `var` 키워드로 선언된 전역 변수나 `함수 선언문으로 정의된 전역 함수`는 `전역 객체(Window 또는 Global)`에 **바인딩**됩니다. 이는 전역 변수나 함수가 해당 전역 객체의 프로퍼티 및 메서드로 접근 가능하게 되는 것을 의미

```javascript
var globalVar = "전역 변수";

function globalFunction() {
    console.log("전역 함수");
}

// 이들은 전역 객체에 바인딩되어 있습니다.
window.globalVar; // "전역 변수"
window.globalFunction(); // "전역 함수"

```

#### 함수 코드 
- 지역 스코프를 생성
- 지역 변수, 매개변수, arguments 객체를 관리
- JavaScript에서 함수가 실행될 때 각 함수에 대해 생성되는 지역 스코프가 전역 스코프와 함께 스코프 체인을 형성

#### eval 코드, 모듈 코드
`eval` 코드는 `strict mode(엄격 모드)`에서 자신만의 독자적인 스코프를 생성
`모듈 코드`는 모듈별로 독립적인 모듈 스코프를 생성
![](https://i.imgur.com/1H1Cqr8.png)

## 23.2 소스코드의 평가와 실행
자바스크립트는 소스코드를 2개의 과정 
- 소스코드의 평가
- 소스코드의 실행
2가지 과정으로 나누어서 처리 한다.

소스코드 평가 과정
- 실행 컨텍스트 생성
- 변수, 함수 등의 선언문을 실행
- 생성된 변수, 함수 식별자를 키로 실행 컨텍스트가 관리하는 스코프에 등록

이 모든 평가과정이 끝나면 선언문을 제외한 소스코드가 순차적으로 실행 **즉 런타임이 실행 된다.**


![](https://i.imgur.com/o3GsnOD.gif)

![](https://i.imgur.com/qpPkBAm.gif)

![](https://i.imgur.com/DCJrBC7.gif)

![](https://i.imgur.com/vH4NMdX.gif)

![](https://i.imgur.com/yyq54cA.gif)

![](https://i.imgur.com/aNoD34N.gif)

## 23.3 실행 컨텍스트의 역할
앞에서 실행컨텍스트에 대해 아래와 같이 설명했다.
**실행 컨텍스트(Execution Context)는 소스코드를 실행하는데 필요한 환경을 제공하고 코드를 실행한다.**

#### 1. 전역 코드 평가
- 소스 코드의 평가 과정에서는 선언문이 먼저 실행된다.
- 전역 코드의 변수 선언문과 함수 선언문이 먼저 실행되고
- 전역변수, 전역함수가 실행 컨텍스트에서 관리하는 전역 스코프에 등록
- 이때 `var`키워드로 선언된 전역 변수와 함수 선언문으로 정의된 전역 함수는 전역 객체의 프로퍼티와 메서드가 된다.

```javascript
var globalVar = "전역 변수";

function globalFunction() {
    console.log("전역 함수");
}

// 이들은 전역 객체에 바인딩되어 있습니다.
window.globalVar; // "전역 변수"
window.globalFunction(); // "전역 함수"

```

#### 전역 코드 실행
- 전역 코드 평가 과정이 끝나면 런타임이 시작
- 전역코드가 순차적으로 실행
- 전역 변수에 값이 할당되고 함수가 호출
- 함수가 호출되면 전역 코드의 실행을 일시 중단하도 코드 실행 순서를 변경하여 함수 내부로 진입
#### 함수 코드 평가
- 함수내부로 진입하면 함수 내부의 문을 실행하기에 앞서 함수 코드 평가 과정을 진행
- 매개 변수, 지역 변수 선언문이 먼저 실행
- 매개변수와 지역 변수가 실행 컨텍스트가 관리하는 지역 스코프에 등록
- 함수 내부에서 지역 변수처럼 사용 할 수 있는 `argujmets` 객체가 생성되어 지역 스코프에 등록
- this 바인딩도 결정

#### 함수 코드 실행
- 매개변수와 지역 변수에 값이 할당
- 함수 내부에서 `console`을 참조하려고 하면, 먼저 **해당 함수의 지역 스코**프에서 `console`이라는 식별자를 찾습니다.
- 지역 스코프에 `console`이라는 식별자가 없다면, `스코프 체인`을 통해 **상위 스코프로 탐색**을 계속합니다.
- 스코프 체인을 따라 가장 상위에 있는 전역 스코프까지 탐색을 계속하며, 전역 스코프에서 `console` 객체를 찾습니다.
- 전역 스코프에서 `console` 객체를 찾은 후, 이 객체의 메소드인 `log`를 호출합니다.
	- `console` 객체는 전역 스코프에 바인딩된 전역 객체의 프로퍼티입니다.
![](https://i.imgur.com/laP4UFI.png)


이렇게 코드가 실행되려면 스코프, 식별자, 코드 실행 순서 등의 관리가 필요하다.
- 식별자(변수, 함수, 클래스 등의 이름)을 등록하고 관리하는 스코프
- 코드 실행 순서관리를 구현한 내부 매커니즘
- **모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.**

## 23.4 실행 컨텍스트 스택
---
- 자바스크립트 엔진은 먼저 전역 코드를 평가해서 전역 실행 콘텍스트를 생성
- 함수가 호출되면 함수 코드를 평가하여 함수 실행 콘텍스트 생성

이렇게 생성된 실행컨텍스트는 `스택`이라는 자료 구조로 관리되는데 이를 **실행 컨텍스트 스택**이라고 한다.


```javascript
const x = 1;

function foo () {
  const y = 2;

  function bar () {
    const z = 3;
    console.log(x + y + z);
  }

  bar();
}

foo(); // 6
```

![](https://i.imgur.com/KNIC552.png)

#### 1. 전역 코드의 평가와 실행
- 자바스크립트 엔진은 먼저 전역 코드를 평가하여 전역 실행 컨텍스트를 생성
- 실행 컨텍스트 스택에 push
- 이때 전역변수 `x`와 전역함수 `foo`는 전역 실행 컨텍스트에 등록 된다.
- 이후 런타임때 `x`의 값이 할당되고 `foo`가 호출 된다.

#### 2. foo 함수 코드의 평가와 실행
- 전역함수 `foo`가 호출되면 전역 코드의 실행은 일시 중단
- 코드의 제어권이 `foo`함수 내부로 이동
- 자바스크립트 엔진은 `foo` 함수 내부의 코드를 평가하여 `foo`함수 실행 컨텍스트를 생성
- 실행컨텍스트 스택에 PUSH 한다.
- 이때 `foo`함수의 지역변수 `y`와 중첩함수 bar가 `foo`함수 실행 컨텍스트에 등록
- 이후 `foo`함수 코드가 실행될때 `y`의 값이 할당되고 중첩함수 `bar`이 호출된다.
#### 3. bar 함수 코드의 평가와 실행
- `bar`이 호출되면 `foo` 함수의 실행은 중단되고 코드의 제어권이 `bar`함수 내부로 이동
- 자바스크립트 엔진은 `bar`함수 내부의 함수 코드를 평가하여 `bar` 실행 컨텍스트를 생성
- 실행 컨텍스트 스택에 PUSH
- 이때 `bar`함수의 지역 변수 `z`가 `bar`함수의 실행 컨텍스트에 등록
- `bar`함수가 실행될때 지역 변수 `z`에 값이 할당되고 `console.log`메서드를 호출한 이후 bar 함수는 종료된다.
#### 4. 종료
- `bar`함수가 종료되면 제어권은 다시 `foo`함수로 이동
- 이때 자바스크립트 엔진은 `bar` 함수 실행 컨텍스트를 POP 하여 제거
- `foo` 함수도 더이상 실행될 코드가 없으니 종료
- 제어권은 다시 전역 코드로 이동한다.
- 이때 자바스크립트 엔진은 `foo` 함수 실행 컨텍스트를 POP 하여 제거
- 실행할 전역 코드가 없으므로 전역 실행 컨텍스트도 실행 컨텍스트 스택에서 POP하여 제거한다.

이렇게 실행 컨텍스트 스택은 코드의 실행 순서를 관리한다.
소스코드가 평가되면 실팽 컨텍스트가 생성되고, 실행 컨텍스트의 최 상위에 쌓이다.
실행 컨텍스트 스택의 최상위에 존재하는 실행 컨텍스트를 **실행중인 실행 컨텍스트**라고 부른다.


## 23.5 렉시컬 환경

- 자바스크립트의 실행 컨텍스트의 일부로, 식별자와 그 식별자에 바인딩된 값 사이의 관계를 관리
- 키와 값을 갖는 객체 형태의 스코프(전역, 함수, 블록 스코프)를 생성
- 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리한다.

![](https://i.imgur.com/udVmICa.png)

![](https://i.imgur.com/e6iaQxh.png)

- 환경 레코드(Environment Record)
	- 스코프에 포함된 식별자를 등록하고 등록된 식별자에 바인딩된 값을 관리하는 저장소
- 외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)
	- 상위 스코프를 가르킨다.
	- 해당 실행 컨텍스트를 생선한 소스코드를 포함하는 상위 코드의 렉시컬 환경
	- 이 외부 렉시켤 환경에 대한 참조를 통해 단방향 링크드 리스트인 스코프 체인을 구현한다.

## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정

```javascript
var x = 1;
const y = 2;

function foo(a) {
  var x = 3;
  const y = 4;

  function bar(b) {
    const z = 5;
    console.log(a + b + x + y + z);
  }

  bar(10);
}

foo(20); // 42

```

### 23.6.1 전역 객체 생성
**전역 코드가 평가 되기 이전에 전역 객체를 생성 한다.**
아래와 같은 객체가 추가 된다.
- 빌트인 전역 프로퍼티
- 빌트인 전역 함수
- 표준 빌트인 객체
- Web API(DOM, BOM, Canvas, XMLHttpRequest, fetch, requestAnimationFrame, SVG, Web Storage, Web Component, Web Worker 등)
- `Object.prototype`을 상속 받는다.

### 23.6.2 전역 코드 평가
소스코드가 로드되면 자바스크립트 엔진은 전역 코드를 평가 한다.
1. 전역 실행 컨텍스트 생성
2. 전역 렉시컬 환경 생성
	1. 전역 환경 레코드 생성
		1. 객체 환경 레코드 생성
		2. 선언적 환경 레코드 생성
	2. this. 바인딩
	3. 외부 렉시컬 환경에 대한 참조 결정

![](https://i.imgur.com/Y7deohz.png)

#### 1. Global 실행 컨텍스트 생성

- 먼저 비어있는 전역 실행 컨텍스트를 생성
- 실행 컨텍스트 스택에 PUSH 한다.
	- 이때 전역 실행 컨텍스트는 실행 컨텍스트(running execution context)가 된다.
#### 2. Global Lexical Environment 생성 
렉시컬 환경은 2개의 컴포넌트로 이루어져 있다.
- 환경 레코드(Environment Record)
- 외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)

##### 2.1 Global Environment Record 생성
- 전역 변수를 관리하는 전역 스코프
- 전역 객체의 빌트인 전역 프로퍼티
- 빌트인 전역함수, 표준 빌트인 객체를 제공한다.


전역 객체 환경 레코드는 아래 2가지로 나누어진다.
- Object Environment Record(객체 환경 레코드)
	- 기존의 `var` 키워드로 선언한 전역변수
	- 함수 선언문으로 정의한 전역함수
	- 빌트인 전역 프로퍼티와 빌트인 전역 함수, 표준 빌트인 객체를 관리
- Declarative Enviornment Record(선언적 환격 레코드)
	- `let`, `const`로 선언한 전역 변수

###### 2.1.1 객체 환경 레코드 생성
- Object Environment Record는 `BindingObject`라고 부르는 객체와 연결
> `Binding Object`
> 전역 코드가 평가 되기 이전에 생성된 전역 객체

- `var`키워드로 선언된 전역 변수와 함수 선언문으로 정의된 전역 함수
- GlobalEnvironment

전역 환경 레코드의 객체 환경레코드에 연결된 `BindingObject`를 통해 전역 객체의 프로퍼티와 메서드가 된다.

![](https://i.imgur.com/6COyTww.png)

```javascript
var x = 1;
const y = 2;

function foo(a) {
...
```
- `X` 변수는 `var` 키워드로 선언한 변수
- 전역코드 평가 시점에 개체 환경 레코드에 바인딩된 `BindingObject`를 통해 전역 객체에 변수 식별자를 키로 등록한 다음 암묵적으로 `undefined`를 바인딩 한다.
- 함수 선언문도 동일!
- 함수 선언문으로 정의한 함수가 평가되면 함수 이름과 동일한 이름의 식별자를 객체환경레코드에 바인딩된 `BindingObject`를 통해 전역 객체에 키로 등록하고 **생성된 함수를 즉시 할당**한다.


### 2.1.2 선언적 환경 레코드 생성
![](https://i.imgur.com/q9frYb9.png)

- `let`, `const` 키워드로 선언한 전역 변수는 선언적 환경 레코드(Declarative Environment Record)에 등록되고 관리
- 이들은 바로 `wwindow` 객체의 프로퍼티가 되지 않는다.
- 즉 선언 단계와 초기화 단계가 분리되어 진행된다.
- 이렇기 때문에 런타임 실행 흐름이 변수 선언문에 도달하기 전까지 **일시적 사각 지대**에 빠지게 된다.

## 2.2 this 바인딩
- 전역 환경 레코드의 `[[GlobalThisValue]]`의 내부 슬롯에 `this`가 바인딩
- 일반적으로 전역 코드에서 `this`는 전역 객체를 가르키기 때문에 `window`객체가 바인딩 된다.
- 그래서 전역 코드에서 `this`
를 참조하면 `[[gLOBALtHISvALUE]]` 내부 슬롯에 바인딩 되어 있는 객체인 `window` 객체가 바인딩 된다.

## 2.3 외부 렉시컬 환경에 대한 참조 결정
`외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference`는 현재 평가중인 소스코드를 포함하는 외부 소스코드의 렉시컬 환경, 즉 상위 스코프를 가르킨다.

이를 통해 단방향 링크드 리스트인 스코프 체인을 구현한다.
현재는 전역이기 때문제 `null`을 할당한다.

![](https://i.imgur.com/UMGQr5j.png)

### 23.6.3 전역 코드 실행
- 이제 전역 코드가 순차적으로 실행 되기 시작
- 전역 변수 x, y에 값이 할당
- `foo` 함수가 호출된다.

변수 할당문 또는 함수 호출문을 싱행하려면 먼저 변수 또는 함수 이름이 선언된 식별자인지 확인이 필요한다.

이를 위해 실행중인 실행 컨텍스트에서 식별자를 검색한다.
이는 실행 컨텍시트의 lexical environment에 등록되어 있어 `x, y, foo`를 검색한다.
만약 식별자를 찾을 수 없으면 상위 스코프로 이동하여 식별자를 검색한다.




